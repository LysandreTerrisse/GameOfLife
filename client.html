<!DOCTYPE html>
<html lang="fr">
<head>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="./fonctions_de_jeu.js" type="text/javascript" language="javascript"></script>
    <script src="./fonctions_de_dessin.js"></script>
    <script src="./fonctions_interface.js"></script>
    <script src="./fonctions_aleatoire.js"></script>
    <script src="./fonctions_de_collisions.js"></script>
    <script src="./fonctions_de_choix.js"></script>
    <script>
    //var {genererTerrain, genererEntites, tick} = require("./fonctions_de_jeu");
    //var {enleverInputsCreationPartie, enleverInputsDeConnexion} = require("./fonctions_de_dessin");
    var socket = io();
    
    var liste_terrain = [];
    var liste_entites = [];
    var identifiant_secret = 0;
    
    socket.on("infos", (infos) => { // Quand on reçoit les infos du serveur
        console.log(infos);
        //On obtient la graine de génération pseudo-aléatoire du serveur
        if(!isSeedSet()) {
          setSeed(infos.seed);
        }
        
        //S'il y a au moins un joueur
        if(infos.liste_joueurs.length != 0) {
            //On modifie l'interface
            enleverInputsCreationPartie(); // On enlève les éléments spécifiques au premier joueur
            document.getElementById("paragraphe_liste_joueurs").innerHTML = infos.liste_joueurs.join(" "); // On affiche la liste des joueurs
            
            //Si l'on n'avait pas encore généré puis affiché le terrain, on le fait
            if(liste_terrain.length==0) {
                liste_terrain = genererTerrain(infos.nb_joueurs_max, infos.nb_lignes, infos.nb_colonnes);
                liste_entites = genererEntites(infos.nb_joueurs_max, infos.nb_entites_par_joueur, infos.liste_forces, infos.liste_perceptions, infos.liste_taux_reproduction, infos.nb_sexes, infos.nb_lignes, infos.nb_colonnes)
                dessinerPremiereFois(liste_terrain, liste_entites, 10, 30);
            }
            
            // Si l'on a le bon nombre de joueurs
            if(infos.liste_joueurs.length == infos.nb_joueurs_max) {
                boucle(infos.debut_partie, liste_entites, liste_terrain, infos.nb_iterations_max)// On commence la partie
            }
        }
    });
    
    socket.emit('obtenir_infos'); // On demande les infos au serveur
    
    socket.on("identifiant_secret", (identifiant_secret_obtenu) => { // Quand on reçoit l'identifiant secret
        identifiant_secret = identifiant_secret_obtenu; // On le stocke
    });
    
    /* S'exécute quand on appuie sur le bouton "Jouer" */
    function demanderJoindrePartie() {
        // On enlève les inputs de connexion
        enleverInputsDeConnexion();
        // On extrait les informations des champs
        let [nom_joueur, force, perception, taux_reproduction, nb_joueurs, nb_entites_par_joueur, nb_iterations, nb_sexes, nb_lignes, nb_colonnes] = extraireDepuisInterface();
        // On affiche le nom du joueur
        document.getElementById("paragraphe_nom_joueur").innerHTML = nom_joueur;

        //On prépare les informations à envoyer
        let infos_client = {
            nom_joueur: nom_joueur,
            force: force,
            perception: perception,
            taux_reproduction: taux_reproduction,
            nb_joueurs_max: nb_joueurs,
            nb_entites_par_joueur: nb_entites_par_joueur,
            nb_iterations_max: nb_iterations,
            nb_sexes: nb_sexes,
            nb_lignes: nb_lignes,
            nb_colonnes: nb_colonnes
        }

        // On envoie une requête au serveur
        socket.emit('ajouter_joueur', infos_client);
    }
    
    /*
    
    Il ne reste plus qu'à :
    - Faire un algorithme de plus court chemin
    - Implémenter le paramètre "vision à distance"
    - Implémenter un algorithme de choix
    - Implémenter le système de points
    - Empêcher l'appui de boutons lorsque paramètres invalides
    */
    </script>
</head>
<body>
    <header>
        <div id="menu_connexion">
            <h3>Connexion</h3>
            Nom du joueur : <input type="text" id="champ_nom_joueur" /> </br>
            Nombre de points non répartis : <a id="paragraphe_points_non_repartis"></a> / 9 </br> <!-- À implémenter -->
            Force des créatures : <input type="range" id="champ_force" oninput="updateStats()" min="1" max="5" value="3" /> <a id="paragraphe_force"></a> </br> <!-- À implémenter -->
            Perception des créatures : <input type="range" id="champ_perception" oninput="updateStats()" min="1" max="5" value="3" /> <a id="paragraphe_perception"></a> </br> <!-- À implémenter -->
            Taux de reproduction des créatures : <input type="range" id="champ_taux_reproduction" oninput="updateStats()" min="1" max="5" value="3" /> <a id="paragraphe_taux_reproduction"></a> </br> <!-- À implémenter -->
        </div>
        <div id="menu_creation_partie">
            <h3>Création d'une partie</h3>
            Nombre de joueurs : <input type="number" id="champ_nb_joueurs" /></br>
            Nombre d'entités par joueur : <input type="number" id="champ_nb_entites_par_joueur" /></br>
            Nombre d'itérations : <input type="number" id="champ_nb_iterations" /></br>
            Nombre de sexes : <input type="number" id="champ_nb_sexes" /></br>
            Nombre de lignes : <input type="number" id="champ_nb_lignes" /></br>
            Nombre de colonnes : <input type="number" id="champ_nb_colonnes" /></br>
        </div>
        <div id="menu_partie">
            <h3>Jeu de la vie</h3>
            Nom du joueur : <a id="paragraphe_nom_joueur"></a> </br>
            Liste des joueurs : <a id="paragraphe_liste_joueurs"></a> </br>
        </div>
        
        <input type="button" id="bouton_jouer" onclick="demanderJoindrePartie()" value="Jouer" />
    </header>
    <script>updateStats();</script>
    

    <div id="tablier"></div>
</body>
</html>
